clean_met_gene <- df_met_gene %>%
filter(human.mouse == species_name) %>%
select(
Metabolite,
Target = Gene,
Target_ID = Gene.ID,
Interaction = Alteration,
PMID_Met_Target = PMID
) %>%
distinct()
merged_axis <- full_join(clean_bac_met, clean_met_gene, by = "Metabolite") %>%
select(
Bacteria,
Bacteria_ID,
Metabolite,
Metabolite_ID,
Target,
Target_ID,
Interaction,
PMID_Bac_Met,
PMID_Met_Target)
return(merged_axis)
}
View(df_bac_gene)
# 1. ç”Ÿæˆäººç±»æ•°æ® (Human)
gut_axis_human <- process_species_data("human")
View(gut_axis_human)
# 2. ç”Ÿæˆå°é¼ æ•°æ® (Mouse)
gut_axis_mouse <- process_species_data("mouse")
View(gut_axis_mouse)
View(gut_axis_human)
unique(gut_axis_human$Bacteria)
gut_axis_human[is.na(gut_axis_human$Bacteria), ]
gut_axis_human[is.na(gut_axis_human$Bacteria), ] |> head()
usethis::use_data(gut_axis_human, gut_axis_mouse, overwrite = TRUE)
getwd()
setwd("/Users/hinna/TCMDATA/data-raw")
usethis::use_data(gut_axis_human, gut_axis_mouse, overwrite = TRUE)
gutMGene <- list(gut_axis_human = gut_axis_human,
gut_axis_mouse = gut_axis_mouse)
View(gutMGene)
usethis::use_data(gutMGene, overwrite = TRUE)
View(gut_axis_mouse)
setdiff
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
res <- runMCODE(ppi)
library(igraph)
res <- runMCODE(ppi)
View(res)
str(res)
# 1. æå– Module_1 çš„å­ç½‘
module1_genes <- res$complexes$Module_1
sub_g1 <- induced_subgraph(g, module1_genes) # g æ˜¯ä½ è¾“å…¥çš„åŸå§‹ç½‘ç»œ
sub_g1 <- induced_subgraph(ppi, module1_genes) # g æ˜¯ä½ è¾“å…¥çš„åŸå§‹ç½‘ç»œ
# 2. ç®€å•çš„å¯è§†åŒ–
plot(sub_g1,
layout = layout_with_fr,
vertex.label = V(sub_g1)$name,
vertex.color = "orange",
vertex.size = 20,
main = "Top MCODE Module: Inflammation")
rm(list = ls())
library(dplyr)
## load raw data
df_bac_met <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Microbial metabolite.csv")
df_bac_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Host Gene.csv")
df_met_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Microbial metabolite-Host Gene.csv")
## process function
process_species_data <- function(species_name) {
# microbe-metablites
clean_bac_met <- df_bac_met %>%
filter(human.mouse == species_name) %>%
select(
Bacteria = Gut.Microbiota,
Bacteria_ID = Gut.Microbiota.NCBI.ID,
Metabolite,
Metabolite_ID = Metabolite.PubChem.CID,
PMID_Bac_Met = PMID
) %>%
distinct()
# metabolite-targets
clean_met_gene <- df_met_gene %>%
filter(human.mouse == species_name) %>%
select(
Metabolite,
Target = Gene,
Target_ID = Gene.ID,
Interaction = Alteration,
PMID_Met_Target = PMID
) %>%
distinct()
merged_axis <- full_join(clean_bac_met, clean_met_gene, by = "Metabolite") %>%
select(
Bacteria,
Bacteria_ID,
Metabolite,
Metabolite_ID,
Target,
Target_ID,
Interaction,
PMID_Bac_Met,
PMID_Met_Target)
return(merged_axis)
}
## process raw data
gut_axis_human <- process_species_data("human")
gut_axis_mouse <- process_species_data("mouse")
gutMGene <- list(gut_axis_human = gut_axis_human,
gut_axis_mouse = gut_axis_mouse)
usethis::use_data(gutMGene, overwrite = TRUE)
getwd()
usethis::use_package("igraph")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
library(igraph)
res <- runMCODE(ppi)
str(res)
node_df <- as_data_frame(g, what = "vertices")
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
ppi <- runMCODE(ppi)
str(ppi)
node_df <- as_data_frame(ppi, what = "vertices")
cluster_ranking <- node_df %>%
filter(!is.na(mcode_cluster)) %>%          # 1. è¿‡æ»¤æ‰æ²¡è¿›æ¨¡å—çš„â€œæ•£æˆ·â€èŠ‚ç‚¹
select(mcode_cluster, mcode_module_score) %>% # 2. åªçœ‹æ¨¡å—åå’Œåˆ†æ•°
distinct() %>%                             # 3. å»é‡ï¼ˆå› ä¸ºåŒæ¨¡å—æ¯ä¸ªåŸºå› éƒ½å¸¦åˆ†æ•°ï¼Œåªç•™ä¸€ä¸ªå³å¯ï¼‰
arrange(desc(mcode_module_score))          # 4. æŒ‰åˆ†æ•°é™åºæ’åˆ—
View(cluster_ranking)
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
ppi <- runMCODE(ppi)
str(ppi)
cluster_ranking <- node_df %>%
filter(!is.na(mcode_cluster)) %>%          # 1. è¿‡æ»¤æ‰æ²¡è¿›æ¨¡å—çš„â€œæ•£æˆ·â€èŠ‚ç‚¹
select(mcode_cluster, mcode_module_score, mcode_is_seed) %>% # 2. åªçœ‹æ¨¡å—åå’Œåˆ†æ•°
distinct() %>%                             # 3. å»é‡ï¼ˆå› ä¸ºåŒæ¨¡å—æ¯ä¸ªåŸºå› éƒ½å¸¦åˆ†æ•°ï¼Œåªç•™ä¸€ä¸ªå³å¯ï¼‰
arrange(desc(mcode_module_score))          # 4. æŒ‰åˆ†æ•°é™åºæ’åˆ—
node_df <- as_data_frame(ppi, what = "vertices")
cluster_ranking <- node_df %>%
filter(!is.na(mcode_cluster)) %>%          # 1. è¿‡æ»¤æ‰æ²¡è¿›æ¨¡å—çš„â€œæ•£æˆ·â€èŠ‚ç‚¹
select(mcode_cluster, mcode_module_score, mcode_is_seed) %>% # 2. åªçœ‹æ¨¡å—åå’Œåˆ†æ•°
distinct() %>%                             # 3. å»é‡ï¼ˆå› ä¸ºåŒæ¨¡å—æ¯ä¸ªåŸºå› éƒ½å¸¦åˆ†æ•°ï¼Œåªç•™ä¸€ä¸ªå³å¯ï¼‰
arrange(desc(mcode_module_score))          # 4. æŒ‰åˆ†æ•°é™åºæ’åˆ—
View(cluster_ranking)
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
source("/Users/hinna/TCMDATA/R/runMCODE.R")
ppi <- runMCODE(ppi)
ppires <- getMCODE_res(ppi)
source("/Users/hinna/TCMDATA/R/runMCODE.R")
ppi <- readRDS("/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds")
ppi <- runMCODE(ppi)
ppires <- getMCODE_res(ppi)
View(ppires)
###
library(httr)
library("jsonlite")
url <- "https://admetlab3.scbdd.com/api/washmol"
body <- list(
"SMILES" = "CC(C)OC(=O)CC(=O)CSc1nc2c(cc1C#N)CCC2",
)
body <- list(
"SMILES" = "CC(C)OC(=O)CC(=O)CSc1nc2c(cc1C#N)CCC2"
)
response <- POST(url, body=body, encode="json")
content(response)
View(response)
# 1. åŠ è½½å¿…è¦çš„åŒ…
# å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œè¯·å…ˆè¿è¡Œ: install.packages(c("httr2", "jsonlite", "dplyr"))
library(httr2)
library(jsonlite)
library(dplyr)
# ADMETlab 3.0 çš„é¢„æµ‹æ¥å£ URL
# é€šå¸¸æ˜¯ /prediction æˆ– /calculateï¼Œæ ¹æ®æ–‡æ¡£é“¾æ¥æ¨æµ‹æ˜¯è¿™ä¸ªï¼š
api_url <- "https://admetlab3.scbdd.com/api/prediction"
# å‡†å¤‡æµ‹è¯•æ•°æ® (ä¸¤ä¸ªç®€å•çš„åˆ†å­ï¼šé˜¿å¸åŒ¹æ— å’Œ å’–å•¡å› )
test_smiles <- c(
"CC(=O)OC1=CC=CC=C1C(=O)O",          # Aspirin
"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"       # Caffeine
)
# 1. æ„é€ è¯·æ±‚ä½“ (Payload)
# è¿™é‡Œå‡è®¾ API æ¥å—çš„å‚æ•°åæ˜¯ "smiles" ä¸”æ˜¯ä¸€ä¸ªåˆ—è¡¨
# å¦‚æœæŠ¥é”™ï¼Œå¯èƒ½éœ€è¦æ”¹æˆ list(text = paste(test_smiles, collapse="\n"))
payload <- list(smiles = test_smiles)
# 2. æ„å»ºè¯·æ±‚å¯¹è±¡
req <- request(api_url) %>%
req_method("POST") %>%
req_headers("Content-Type" = "application/json") %>%
req_body_json(payload)
# 3. æ‰§è¡Œè¯·æ±‚ (å¸¦æœ‰é”™è¯¯å¤„ç†)
tryCatch({
resp <- req_perform(req)
message("âœ… è¯·æ±‚æˆåŠŸï¼çŠ¶æ€ç : ", resp_status(resp))
# 4. è§£æç»“æœ
# å°†è¿”å›çš„ JSON è½¬æ¢ä¸º R å¯¹è±¡
resp_json <- resp_body_json(resp, simplifyVector = TRUE)
# -----------------------------------------------------------------------
# æ¢ç´¢æ•°æ®ç»“æ„ (Debug å…³é”®æ­¥éª¤)
# -----------------------------------------------------------------------
message("\n--- æœåŠ¡å™¨è¿”å›çš„æ•°æ®ç»“æ„ ---")
print(str(resp_json, max.level = 1))
message("\n--- å°è¯•æå–ç»“æœè¡¨ ---")
# é€šå¸¸æ•°æ®ä¼šè—åœ¨ resp_json æˆ– resp_json$data é‡Œ
if (is.data.frame(resp_json)) {
final_df <- resp_json
} else if ("data" %in% names(resp_json)) {
final_df <- as.data.frame(resp_json$data)
} else {
warning("è¿”å›ç»“æ„æ¯”è¾ƒç‰¹æ®Šï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ resp_json")
final_df <- NULL
}
if (!is.null(final_df)) {
print(head(final_df))
message("\n--- åˆ—åé¢„è§ˆ (è¯·æ£€æŸ¥æ˜¯å¦æœ‰ MW, logP ç­‰) ---")
print(colnames(final_df)[1:10]) # åªçœ‹å‰10ä¸ªåˆ—å
}
}, error = function(e) {
message("âŒ è¯·æ±‚å¤±è´¥: ", e$message)
message("å¯èƒ½æœ‰ä»¥ä¸‹åŸå› ï¼š")
message("1. API URL ä¸å¯¹ (è¯·æ ¸å¯¹ Swagger æ–‡æ¡£)")
message("2. å‚æ•°æ ¼å¼ä¸å¯¹ (æ¯”å¦‚å®ƒåªæ¥å— text æ ¼å¼è€Œä¸æ˜¯ json)")
message("3. ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨ç»´æŠ¤")
})
content(response)
View(response)
#' It automatically handles batching to avoid server timeouts.
#'
#' @param smiles A character vector of SMILES strings.
#' @param batch_size Integer. Number of molecules per request. Default 50.
#' @param api_url Character. The API endpoint. Default "https://admetlab3.scbdd.com/api/admet".
#'
#' @importFrom httr2 request req_method req_body_json req_retry req_perform resp_body_json
#' @importFrom dplyr bind_rows
#' @return A data frame containing ADMET properties (MW, logP, Toxicity, etc.).
#' @export
runADMET <- function(smiles,
batch_size = 50,
api_url = "https://admetlab3.scbdd.com/api/admet") {
# 1. Input Validation
if (!is.character(smiles)) {
stop("Input 'smiles' must be a character vector.")
}
# Clean input: remove NAs and duplicates
smiles <- unique(smiles[!is.na(smiles) & smiles != ""])
total <- length(smiles)
if (total == 0) {
warning("No valid SMILES provided.")
return(data.frame())
}
message(sprintf("ğŸš€ Starting ADMETlab 3.0 prediction for %d molecules...", total))
# 2. Prepare Batches
# Splitting the vector into chunks of 'batch_size'
batches <- split(smiles, ceiling(seq_along(smiles) / batch_size))
results_list <- list()
# Progress Bar
pb <- txtProgressBar(min = 0, max = length(batches), style = 3)
# 3. Processing Loop
for (i in seq_along(batches)) {
current_batch <- batches[[i]]
# Construct Payload: {"SMILES": ["smi1", "smi2", ...]}
# Python's list maps to R's unnamed list or vector in jsonlite,
# but strictly speaking, to get ["a", "b"], a character vector is fine.
payload <- list(SMILES = current_batch)
tryCatch({
# Build Request
req <- httr2::request(api_url) %>%
httr2::req_method("POST") %>%
httr2::req_headers("Content-Type" = "application/json") %>%
httr2::req_body_json(payload) %>%
# Retry logic: up to 3 times, waiting exponentially
httr2::req_retry(max_tries = 3, backoff = ~ 2) %>%
httr2::req_timeout(120) # 2 minutes max per batch
# Perform Request
resp <- httr2::req_perform(req)
# Parse JSON
# simplifyVector = TRUE will try to convert the 'data' list directly to a data.frame
body <- httr2::resp_body_json(resp, simplifyVector = TRUE)
# Extract Data
if ("data" %in% names(body)) {
batch_df <- as.data.frame(body$data)
# Append input SMILES if not present (optional, usually API returns it)
# if (!"SMILES" %in% colnames(batch_df)) batch_df$SMILES <- current_batch
results_list[[i]] <- batch_df
} else {
warning(paste("Batch", i, "returned unexpected format."))
}
}, error = function(e) {
warning(paste("\nâŒ Batch", i, "failed:", e$message))
})
setTxtProgressBar(pb, i)
}
close(pb)
# 4. Combine and Return
if (length(results_list) == 0) {
warning("No results retrieved.")
return(data.frame())
}
final_df <- dplyr::bind_rows(results_list)
message(sprintf("\nâœ… Prediction complete. Retrieved %d rows.", nrow(final_df)))
return(final_df)
}
a <- runADMET("CC(C)OC(=O)CC(=O)CSc1nc2c(cc1C#N)CCC2")
View(gut_axis_human)
library(dplyr)
library(readr)
library(igraph)
# è¯»å–ä½ ä¸Šä¼ çš„ä¸¤ä¸ªCSVæ–‡ä»¶
# file1: èŒ -> åº•ç‰© -> ä»£è°¢ç‰©
df_upstream <- read_csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Microbial metabolite.csv", show_col_types = FALSE) %>%
select(
Microbe = `Gut Microbiota`,
Substrate = Substrate,
Metabolite = Metabolite
) %>%
# å°†ä»£è°¢ç‰©åç§°è½¬ä¸ºå¤§å†™ï¼Œç¡®ä¿åˆå¹¶æ—¶ä¸ä¼šå› ä¸ºå¤§å°å†™é—®é¢˜æ¼æ‰æ•°æ®
mutate(Metabolite_Key = toupper(Metabolite))
View(df_upstream)
#' add a demo igraph object for PPI analysis
library(yulab.utils)
pload("clusterProfiler")
pload("igraph")
#' add a demo igraph object for PPI analysis
dir <- "/Users/hinna/Desktop/yulab/casestudy/ppi_example.rds"
ppi <- readRDS(dir)
demo_ppi <- readRDS(dir)
usethis::use_data(demo_ppi, overwrite = TRUE)
str(ppi)
devtools::load_all()
getwd()
setwd("/Users/hinna/TCMDATA")
devtools::load_all()
data(demo_ppi)
library(igraph)
ppi.subset <- ppi_subset(demo_ppi, score_cutoff = 0.7)
str(ppi.subset)
data(demo_ppi)
View(demo_ppi)
str(demo_ppi)
rm(list = ls())
#' add a demo igraph object for PPI analysis
dir <- "/Users/hinna/Desktop/yulab/casestudy/demo_ppi.rds"
demo_ppi <- readRDS(dir)
usethis::use_data(demo_ppi, overwrite = TRUE)
rm(list = ls())
devtools::load_all()
data(demo_ppi)
library(igraph)
ppi.subset <- ppi_subset(demo_ppi, score_cutoff = 0.7)
str(ppi.subset)
ppi <- compute_nodeinfo(ppi.subset)
r <- rank_ppi_nodes(ppi)
a1 <- r[[1]]
a2 <- r[[2]]
View(r)
a2
devtools::load_all()
data(demo_ppi)
ppi <- compute_nodeinfo(ppi.subset)
r <- rank_ppi_nodes(ppi)
a1 <- r[[1]]
a2 <- r[[2]]
a2
View(a2)
View(a1)
View(a2)
rm(list = ls())
getwd()
rm(list = ls())
library(dplyr)
## load raw data
df_bac_met <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Microbial metabolite.csv")
df_bac_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Host Gene.csv")
df_met_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Microbial metabolite-Host Gene.csv")
View(df_bac_met)
View(df_met_gene)
## process function
process_species_data <- function(species_name) {
# microbe-metablites
clean_bac_met <- df_bac_met %>%
filter(human.mouse == species_name) %>%
select(
Bacteria = Gut.Microbiota,
Substrate = Substrate,
Bacteria_ID = Gut.Microbiota.NCBI.ID,
Metabolite,
Metabolite_ID = Metabolite.PubChem.CID,
PMID_Bac_Met = PMID
) %>%
distinct()
# metabolite-targets
clean_met_gene <- df_met_gene %>%
filter(human.mouse == species_name) %>%
select(
Metabolite,
Target = Gene,
Target_ID = Gene.ID,
Interaction = Alteration,
PMID_Met_Target = PMID
) %>%
distinct()
merged_axis <- full_join(clean_bac_met, clean_met_gene, by = "Metabolite") %>%
select(
Bacteria,
Bacteria_ID,
Substrate,
Metabolite,
Metabolite_ID,
Target,
Target_ID,
Interaction,
PMID_Bac_Met,
PMID_Met_Target)
return(merged_axis)
}
## process raw data
gut_axis_human <- process_species_data("human")
gut_axis_mouse <- process_species_data("mouse")
View(gut_axis_human)
## process function
process_species_data <- function(species_name) {
# microbe-metablites
clean_bac_met <- df_bac_met %>%
filter(human.mouse == species_name) %>%
select(
Bacteria = Gut.Microbiota,
#Substrate = Substrate,
Bacteria_ID = Gut.Microbiota.NCBI.ID,
Metabolite,
Metabolite_ID = Metabolite.PubChem.CID,
PMID_Bac_Met = PMID
) %>%
distinct()
# metabolite-targets
clean_met_gene <- df_met_gene %>%
filter(human.mouse == species_name) %>%
select(
Metabolite,
Target = Gene,
Target_ID = Gene.ID,
Interaction = Alteration,
PMID_Met_Target = PMID
) %>%
distinct()
merged_axis <- full_join(clean_bac_met, clean_met_gene, by = "Metabolite") %>%
select(
Bacteria,
Bacteria_ID,
#Substrate,
Metabolite,
Metabolite_ID,
Target,
Target_ID,
Interaction,
PMID_Bac_Met,
PMID_Met_Target)
return(merged_axis)
}
## process raw data
gut_axis_human <- process_species_data("human")
gut_axis_mouse <- process_species_data("mouse")
rm(list = ls())
library(dplyr)
## load raw data
df_bac_met <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Microbial metabolite.csv")
df_bac_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Gut Microbe-Host Gene.csv")
df_met_gene <- read.csv("/Users/hinna/Desktop/gutMGene/Microbial metabolite-Host Gene.csv")
## process function
process_species_data <- function(species_name) {
# microbe-metablites
clean_bac_met <- df_bac_met %>%
filter(human.mouse == species_name) %>%
select(
Bacteria = Gut.Microbiota,
Substrate = Substrate,
Bacteria_ID = Gut.Microbiota.NCBI.ID,
Metabolite,
Metabolite_ID = Metabolite.PubChem.CID,
PMID_Bac_Met = PMID
) %>%
distinct()
# metabolite-targets
clean_met_gene <- df_met_gene %>%
filter(human.mouse == species_name) %>%
select(
Metabolite,
Target = Gene,
Target_ID = Gene.ID,
Interaction = Alteration,
PMID_Met_Target = PMID
) %>%
distinct()
merged_axis <- full_join(clean_bac_met, clean_met_gene, by = "Metabolite") %>%
select(
Bacteria,
Bacteria_ID,
Substrate,
Metabolite,
Metabolite_ID,
Target,
Target_ID,
Interaction,
PMID_Bac_Met,
PMID_Met_Target)
return(merged_axis)
}
## process raw data
gut_axis_human <- process_species_data("human")
gut_axis_mouse <- process_species_data("mouse")
gutMGene <- list(gut_axis_human = gut_axis_human,
gut_axis_mouse = gut_axis_mouse)
